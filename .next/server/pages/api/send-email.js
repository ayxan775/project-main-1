"use strict";(()=>{var e={};e.id=55,e.ids=[55],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2048:e=>{e.exports=require("fs")},6624:e=>{e.exports=require("querystring")},9648:e=>{e.exports=import("axios")},6705:e=>{e.exports=import("formidable")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7978:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>l,routeModule:()=>u});var s=r(1802),n=r(7153),a=r(6249),i=r(4762),c=e([i]);i=(c.then?(await c)():c)[0];let l=(0,a.l)(i,"default"),p=(0,a.l)(i,"config"),u=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/send-email",pathname:"/api/send-email",bundlePath:"",filename:""},userland:i});o()}catch(e){o(e)}})},4762:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>u});var s=r(9648),n=r(6624),a=r.n(n),i=r(2048),c=r.n(i),l=r(6705),p=e([s,l]);[s,l]=p.then?(await p)():p;let d={api:{bodyParser:!1}},m=async e=>{try{return(await s.default.post("https://www.google.com/recaptcha/api/siteverify",a().stringify({secret:"6LdnxjorAAAAAEwN4-bFw9FXeKvSlHtWPdvEIOho",response:e}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data.success}catch(e){return console.error("reCAPTCHA verification error:",e),!1}},f=async e=>new Promise((t,r)=>{new l.IncomingForm({maxFileSize:5242880}).parse(e,(e,o,s)=>{e&&r(e),t({fields:o,files:s})})});async function u(e,t){if("POST"===e.method)try{let r;let{fields:o,files:n}=await f(e),i=o.name&&o.name[0],l=o.email&&o.email[0],p=o.subject&&o.subject[0],u=o.message&&o.message[0],d=o.recaptchaToken&&o.recaptchaToken[0];if(!i||!l||!p||!u)return t.status(400).json({error:"All fields are required."});if(!d)return t.status(400).json({error:"reCAPTCHA verification is required."});if(!await m(d))return t.status(400).json({error:"reCAPTCHA verification failed. Please try again."});if(n.attachment&&Array.isArray(n.attachment)&&n.attachment[0]){let e=n.attachment[0];if(e.size>5242880)return t.status(400).json({error:"File size exceeds the 5MB limit."});let o=c().readFileSync(e.filepath).toString("base64");r={fileName:e.originalFilename||"attachment",content:o,contentType:e.mimetype||"application/octet-stream"}}let h={name:i,email:l,subject:p,message:u,attachment:r},g=process.env.OAUTH_CLIENT_ID,A=process.env.OAUTH_CLIENT_SECRET,y=process.env.OAUTH_TENANT_ID,P=process.env.OAUTH_USER_EMAIL,E=process.env.CONTACT_FORM_RECEIVER_EMAIL;if(!g||!A||!y||!P||!E)return console.error("Email configuration environment variables are not fully set."),t.status(500).json({error:"Server configuration error for email.",details:"Required email environment variables missing."});let w="";try{console.log("Attempting to fetch OAuth2 access token...");let e=`https://login.microsoftonline.com/${y}/oauth2/v2.0/token`;if(!(w=(await s.default.post(e,a().stringify({client_id:g,client_secret:A,scope:"https://graph.microsoft.com/.default",grant_type:"client_credentials"}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data.access_token))throw Error("Access token not found in Microsoft token response.");console.log("Successfully fetched OAuth2 access token.")}catch(e){if(console.error("--- Error Fetching OAuth2 Token ---"),console.error("Request URL:",`https://login.microsoftonline.com/${y}/oauth2/v2.0/token`),console.error("Request Body Sent (client_secret redacted):",{client_id:g,client_secret:"[REDACTED]",scope:"https://graph.microsoft.com/.default",grant_type:"client_credentials"}),e.response){console.error("Response Status:",e.response.status),console.error("Response Headers:",JSON.stringify(e.response.headers,null,2)),console.error("Response Data:",JSON.stringify(e.response.data,null,2));let r=e.response.data?.error_description||"No error_description from token endpoint.";return t.status(500).json({error:"Failed to obtain OAuth2 access token.",details:r})}if(e.request)return console.error("No response received for token request:",e.request),t.status(500).json({error:"Failed to obtain OAuth2 access token.",details:"No response from token server."});return console.error("Error setting up token request:",e.message),t.status(500).json({error:"Failed to obtain OAuth2 access token.",details:e.message})}try{console.log("Sending email using Microsoft Graph API...");let e={message:{subject:`Contact Form: ${h.subject}`,body:{contentType:"HTML",content:`
                <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                  <h2 style="color: #333;">New Contact Form Submission</h2>
                  <p><strong>Name:</strong> ${h.name}</p>
                  <p><strong>Email:</strong> <a href="mailto:${h.email}">${h.email}</a></p>
                  <p><strong>Subject:</strong> ${h.subject}</p>
                  <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                  <p><strong>Message:</strong></p>
                  <p style="white-space: pre-wrap; background-color: #f9f9f9; padding: 15px; border-radius: 5px;">${h.message}</p>
                  <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                  <p style="font-size: 0.9em; color: #777;">This email was sent from the contact form on your website.</p>
                </div>
              `},toRecipients:[{emailAddress:{address:E}}],replyTo:[{emailAddress:{address:h.email,name:h.name}}]},saveToSentItems:!1};return h.attachment&&(e.message.attachments=[{"@odata.type":"#microsoft.graph.fileAttachment",name:h.attachment.fileName,contentType:h.attachment.contentType,contentBytes:h.attachment.content}]),await s.default.post("https://graph.microsoft.com/v1.0/users/"+P+"/sendMail",e,{headers:{Authorization:`Bearer ${w}`,"Content-Type":"application/json"}}),console.log("Email sent successfully with Microsoft Graph API."),t.status(200).json({success:!0,message:"Email sent successfully!"})}catch(r){console.error("--- Full Error Object Start (Graph API Email) ---"),console.error(r),console.error("--- Full Error Object End (Graph API Email) ---");let e="Unknown error during email sending with Graph API.";return r.response?(console.error("Graph API Response Status:",r.response.status),console.error("Graph API Response Data:",JSON.stringify(r.response.data,null,2)),e=`Graph API Error: ${r.response.status} - ${JSON.stringify(r.response.data)}`):r instanceof Error?e=r.message:"string"==typeof r&&(e=r),t.status(500).json({error:"Failed to send email.",details:e})}}catch(e){return console.error("Form parsing error:",e),t.status(500).json({error:"Failed to process form data.",details:e instanceof Error?e.message:String(e)})}else t.setHeader("Allow",["POST"]),t.status(405).end(`Method ${e.method} Not Allowed`)}o()}catch(e){o(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7978);module.exports=r})();